---
title: "Como sinais multimodais influenciam o tempo até o início do amplexo?"
author: "Daniel YM Nakamura e Jennifer P Auler"
date: '28 de novembro de 2022'
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
    number_sections: true
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introdução

<center><img src="fig1.png" width="400"></center>
<center>Figura 1: Ilustração de rã-de-corredeira (Hylodidae: *Hylodes asper*). Fonte: Paulo Presti.</center>

\

Em anuros, o canto de anúncio é aquele emitido por machos para atrair fêmeas ou repelir machos competidores na paisagem acústica (Wells 1977; Duellman & Trueb 1986). A maioria das espécies de anuros apresentam comportamento noturno e portanto são altamente dependentes do canto para se reproduzirem. Contudo, na espécie *Hylodes asper* (Anura: Hylodidae) os machos apresentam comportamento diurno, sedentário e esperam até as fêmeas chegarem nos sítios reprodutivos, onde cantam em superfícies de rochas próximas a águas lóticas (i.e. rios de correnteza intensa ou cachoeiras; Heyer et al. 1990; Haddad & Giaretta 1999). Devido à disponibilidade de luz e ao ruído de fundo das correntezas, sinais visuais podem ser apresentados concomitantemente aos sinais acústicos para maximizar a transmissão de informação entre o macho emissor e as fêmeas ou machos receptores (Hödl et al. 1997). Embora a maioria dos estudos utilize aspectos temporais (e.g. taxa de cantos) ou espectrais (i.e. o quão agudo ou grave o canto é) como variáveis respostas de modelos (e.g. Gingras et al. 2013; Goutte et al. 2016), o tempo em que as fêmeas demoram para chegar nos sítios reprodutivos e iniciarem o amplexo é pouco estudado.

Existem sinais multimodais compostos por características morfológicas, acústicas e visuais que são consideradas mais atrativas pelas fêmeas e podem explicar o tempo até sua chegada e início do amplexo. Por exemplo, uma possível preditora acústica é a **frequência dominante** do canto (DF: a banda com maior concentração de energia no espectro; Köhler et al. 2017), no qual cantos mais graves são considerados mais atrativos e talvez reduzam o tempo até o início do amplexo, pois machos com canto mais grave geralmente tem cordas vocais mais espessas e compridas (McClelland et al. 1996), o que geralmente é um sinal honesto que informa o tamanho corporal do macho (Wells 2007; Köhler et al. 2017). Contudo, existem machos que mentem! Machos mentirosos são comuns em algumas espécies, os quais conseguem modular a frequência do canto (i.e. deixar mais grave por relaxamento dos músculos da cartilagem aritenóide; Martin 1971; Schmid 1979; Ryan 1988). Por isso, incluir o **tamanho corporal** como uma variável preditora é uma forma de avaliar a honestidade da frequência. Por fim, machos da espécie *Hylodes asper* às vezes cantam ao mesmo tempo em que apresentam um display visual chamado <strong><em>foot-flagging</em></strong>, no qual esticam as pernas para chamarem atenção das fêmeas visualmente devido ao barulho das corredeiras que podem reduzir as chances de serem escutados pelas fêmeas (Heyer et al. 1990; Haddad & Giaretta 1999). Portanto, uma última hipótese é que uma taxa de foot-flagging alta reduza o tempo até as fêmeas iniciarem o amplexo.

# Objetivos e hipóteses

O objetivo geral desse trabalho é responder como sinais multi-modais influenciam o tempo até o início do amplexo em *Hylodes asper*. Os objetivos específicos são entender:

1. Como os sinais espectrais de frequência dominante (DF) influenciam o tempo até o início do amplexo?
- H0: Não há influência da DF sobre o tempo até o início do amplexo
- H1: DF é positivamente relacionada com o tempo até o início do amplexo, de modo que machos com canto mais grave (menor DF) copulam antes (menor tempo até o início do amplexo)

2. Como o tamanho corporal influencia o tempo até o início do amplexo?
- H0: Não há influência do tamanho corporal sobre o tempo até o início do amplexo
- H1: Tamanho corporal é negativamente relacionada com o tempo até o início do amplexo, de modo que machos maiores copulam antes

3. Como os sinais visuais de taxa de *foot-flagging* influenciam o tempo até o início do amplexo?
- H0: Não há influência da taxa de *foot-flagging* sobre o tempo até o início do amplexo
- H1: Taxa de *foot-flagging* é negativamente relacionada com o tempo até o início do amplexo, de modo que machos que dançam mais copulam antes

<center><img src="fig2.png" width="500"></center>
<center>Figura 2: Predições para as perguntas do trabalho. Espera-se uma (I) relação positiva entre frequência dominante (DF) e tempo até o amplexo, (II) relação negativa entre tamanho corporal e tempo até o amplexo, e (III) relação negativa entre taxa de foot-flagging e tempo até o amplexo.</center>

\

# Simulação de dados

## Parâmetros biológicos

Embora dados das nossas variáveis preditoras sejam mais acessíveis na literatura, dados da nossa variável resposta (tempo de espera da fêmea até início da cópula) são escassos. Isso ocorre pois é extremamente custoso ao biólogo de campo tentar localizar uma fêmea de anuro próxima dos machos já que elas não cantam e raramente são vistas na natureza. Portanto, optamos pelo uso de dados simulados.

As nossas variáveis preditoras teóricas são frequência do canto, tamanho corporal e *display* de *foot-flagging*. Contudo, precisamos operacionalizar essas variáveis. Utilizamos as seguintes variáveis preditoras operacionais:

- Frequência dominante (DF: medida em Hz), definida como a frequência no espectro harmônico com maior concentração de energia que é percebida pelo ouvido humano como o quão grave ou agudo os sons são (Köhler et al. 2017); 

- Comprimento rostro-cloacal (SVL: *snout-vent length*, medida em mm), o qual é amplamente usado como aproximação do tamanho corporal pois mede o comprimento da extremedidade anterior do focinho até a extremidade posterior da cloaca (Duellman 1970); 

- Taxa de *foot-flagging* (medida em número de eventos/minuto). 

Para *Hylodes asper*, Haddad & Giaretta (1999) reportaram que a DF se encontra no terceiro harmônico entre 5000 a 6500 Hz, com valor de *midpoint* ([máx - min] / 2) igual a 5750 Hz. Heyer et al. (1990) reportaram que os machos apresentam um SVL médio de 40.5 mm (39.4-42.3 mm). Já a taxa de *foot-flagging* não foi reportada por unidade de tempo em nenhum destes trabalhos, mas é possível estimar através de vídeos disponíveis no YouTube (~10 a cada 5 min). Utilizamos estes valores como referência das características dos machos simulados na função 'saposim', disponível no arquivo "R/saposim.R". Além disso, diversas funções acessórias utilizadas neste arquivo para plotagem dos dados e também utilizadas nas simulações estão no arquivo "R/funcoes_auxiliares.R".

```{r ass.function}
source("R/funcoes_auxiliares.R")
```

## Descrição da simulação

A cada simução é criada uma nova matriz de <code>espaco</code> de <code>area</code> linhas e <code>area</code> colunas. Em seguida, são sorteadas as posições que os <code>nmacho</code> ocuparão durante aquela simulação. Os machos de *Hylodes asper* são altamente territoriais e ficam parados, sem mudarem os sítios reprodutivos. Portanto, em nossa simulação, apenas a fêmea se locomove.

Em seguida, os parâmetros da simulação são simulados: frequência dominante do canto <code>freq</code> (DF: Hz), taxa de *foot-flagging* <code>foot</code> (número de eventos de *foot-flagging*/minuto) e tamanho corporal <code>tama</code> (SVL: mm) de cada um dos machos. Estas caracteristicas são sorteadas a partir de uma distribuição  (normal, poisson e normal para DF, taxa de *foot-flagging* e SVL, respectivamente) e, em seguida, padronizadas pela função <code>padroniza</code>. Os valores padronizados aparecem no output como <code>freqpad</code>, <code>footpad</code> e <code>tamapad</code>. É esperado que machos mais próximos à cachoeira tenham menor tamanho corporal (SVL menor) e vocalizem em frequencias mais agudas (DF maior) e portanto tenham, em média, probabilidade menor de atrair fêmeas. No entanto, é esperado que esses machos tenham também maior taxa de *foot-flagging*, o que pode contra-balancear essa esperança. Apesar de estes valores serem correlacionados, as características do macho são sorteadas independentemente de uma distribuição aleatória.

A probabilidade de seleção do macho é então calculada através de uma regressão logistica, 
$$prob = \frac{e^{exprlin}}{1+e^{exprlin}}$$ 
com expressão linear de fórmula: $exprlin = a \times tamanho + b \times taxafootflag + c \times DF$ e intercepto igual à média da expressão linear que, no caso de dados padrozinados é $0$.

Por fim, uma cédula vazia é sorteada para a fêmea ocupar, e esta escolhe um macho para copular com probabilidade <code>prob</code>. A distância <code>distf</code> entre a fêmea e o macho escolhido é calculada pela função <code>dist</code>. A fêmea e o macho são considerados ocupados até o final da simulação e são retirados do <code>espaco</code>. A simulação se repete com <code>nfemea = nmacho</code>. O tempo total <code>ttot</code> para o macho ser escolhido também é guardado, sendo definido como a soma de todas <code>distf</code> anteriores na mesma simulação. A função de simulação de sapos, <code>saposim</code> se encontra na íntegra no arquivo "R/saposim.R".
\
\
```{r figura, echo=FALSE, fig.align = 'center'}
par(mar = c(0,0,1,0))

# Plot vazio
plot(NULL, xlim = c(-2, 12), ylim = c(-2, 12), ann = FALSE, xaxt = "n", yaxt = "n", bty = "n", asp = 1)

# Faz grid
segments(x0 = -1:11, x1 = -1:11, y0 = rep(-1, 11), y1 = rep(11, 11))
segments(x0 = rep(-1, 11), x1 = rep(11, 11), y0 = -1:11, y1 = -1:11)

# Cria cachoeira
mtext(text = "area = 12", at = 5, side = 3, line = 0)
rect(xleft = 11, ybottom = -2, xright = 12, ytop = 12, col = "lightblue")

# Faz labels
text(x = -0.5:10.5, y = 11.5, paste0("C", 1:12), cex = 0.5)
text(x = -1.5, y =  -0.5:10.5, paste0("L", 12:1), cex = 0.5)
text(x = 11.5, y =  5, "cachoeira", cex = 1.5, srt = 270)

# Plota machos
text(x = c(3, 10,  2,  1,  2,  7,  9,  6,  0,  3)+0.5, y = c(9,  1,  8,  9,  5,  4,  2,  8, -1, -1)+0.5, paste0("m", 1:10), cex = c(0.58, 0.29, 0.63, 0.52, 0.58, 0.47, 0.51, 0.40, 0.51, 0.7), col = c(rep("black", 9), "blue")) 

# Plota fêmea
text(x = 4.5, y = 5.5, "F", col = "red")

# Distância entre macho escolhido e fêmea
segments(x0 = 3.5, x1 = 4.3, y0 = -0.5, y1 = 5.5, lty = 2, col = "green")
text(x = 4.15, y = 2.5, "distf = 7.3", col = "green", cex = 0.7)
```

<center>Figura 3 - Uma distribuição hipotética de machos (m1 a m10) e fêmea (F) no espaço. A probabilidade de seleção dos machos está representada pelo tamanho da fonte. Ao lado direito se encontra a cachoeira, que se correlaciona com a probabilidade de seleção. Neste exemplo, o macho "m10" foi escolhido e a sua distancia "distf" foi calculada.</center> 

## Parâmetros das simulações

Além do efeito das características dos sapos, decidimos também investigar se a variação na <code>area</code> da cachoeira é relevante para o tempo até o início do amplexo. Como resultado, apresentamos então quatro simulações:

* <code>sim_Avar</code> - dimensões da cachoeira (<code>area</code>) sorteada de uma distribuição uniforme entre 10 e 100 (arredondada para números inteiros).
* <code>sim_Afix10</code> - dimensões da cachoeira (<code>area</code>) fixa em 10.
* <code>sim_Afix50</code> - dimensões da cachoeira (<code>area</code>) fixa em 50.
* <code>sim_Afix100</code> - dimensões da cachoeira (<code>area</code>) fixa em 100.


Em ambas as simulações foram mantidas os valores padrão:

* <code>nsim</code> = 1000
* <code>vecarea = round(runif(nsim, 10, 100), 0)</code>
* <code>vecnmacho = vecarea</code>
* <code>cffreq</code> = -1.05
* <code>cftama</code> = 0.5
* <code>cffoot</code> = 0.8

O código das simulações está no documento "R/simula_dados.R". Como <code>nsim</code> é grande e leva alguns minutos, salvamos o resultado das simulações como arquivos <code>R.data</code>.

```{r}
load("data/sim_Avar.Rdata")
load("data/sim_Afix10.Rdata")
load("data/sim_Afix50.Rdata")
load("data/sim_Afix100.Rdata")
```

## Estrutura do resultado

O *output* da simulação consiste em uma tabela com as seguintes colunas:

* <code>machoid</code> - número de identificação do macho
* <code>dcach</code> - distância do macho até a cachoeira
* <code>foot</code> - taxa de _footflag_ do macho
* <code>freq</code> - frequência de canto do macho
* <code>tama</code> - tamanho corporal do macho
* <code>footpad</code> - idem foot, padronizado
* <code>freqpad</code> - idem freq, padronizado
* <code>tamapad</code> - idem tama, padronizado
* <code>exprlin</code> - expressão linear da regressão logistica
* <code>prob</code> - probabilidade de seleção do macho
* <code>distf</code> - distância da fêmea até o macho escolhido
* <code>ttot</code> - tempo total entre até a escolha do macho <code>machoid</code>. Este tempo é definido como a soma das <code>distf</code> anteriores
* <code>nsim</code> - número da simulação
* <code>femea</code> - número de identificação da fêmea
* <code>area</code> - tamanho de lado da cachoeira simulada
* <code>femeasim</code> - agregação da informação de <code>nsim</code> e <code>femea</code>.


Para exemplificar, apresentamos as primeiras linhas do dataset simulado com área variada:
```{r}
head(sim_Avar)
```

E o sumário de todas as simulações:

<details>

  <summary>Sumário de sim_Avar</summary>
```{r}
summary(sim_Avar)
```
</details>

<details>

  <summary>Sumário de sim_Afix10</summary>
```{r}
summary(sim_Afix10)
```
</details>

<details>

  <summary>Sumário de sim_Afix50</summary>
```{r}
summary(sim_Afix50)
```
</details>

<details>

  <summary>Sumário de sim_Afix100</summary>
```{r}
summary(sim_Afix100)
```
</details>

# Resultados
Optamos pelo uso de modelos generalizados mistos, pois pode haver um efeito aleatório de cada rio (a variação entre rios pode ser maior do que a variação dentro de um mesmo rio). Além disso, optamos por utilizar a distribuição Gama, que é uma generalização da distribuição exponencial e é uma boa opção para modelar o tempo até N eventos ocorrerem. Esta distribuição possui dois parâmetros: shape ($k$) e scale ($\theta$). Como nossa variável é o tempo até um determinado macho atingir amplexo, a distribuição Gammma é apropriada.

É frequente que os GLMM Gama sejam difíceis de implementar, especialmente utilizando a função de ligação canônica <code>"inverse"</code> (Bolker at al 2022). Por esse motivo, alguns autores, como Lo e Andrews (2015) indicam utilizar a função de ligação <code>"log"</code>, a qual utilizaremos aqui.

Os seguintes pacotes foram utilizados para as análises estatísticas e plotagem:

```{r message=FALSE, warning=FALSE}
library(lme4) # Linear Mixed-Effects Models using 'Eigen' and S4
library(MASS) # Support Functions and Datasets for Venables and Ripley's MASS
library(bbmle) # Tools for General Maximum Likelihood Estimation
library(interactions) # Comprehensive, User-Friendly Toolkit for Probing Interactions
library(multcomp) # Simultaneous Inference in General Parametric Models
library(tibble) # Simple Data Frames
library(tidyverse) # Easily Install and Load the 'Tidyverse'
library(broom) # Convert Statistical Objects into Tidy Tibbles
library(AICcmodavg) # Model Selection and Multimodel Inference Based on (Q)AIC(c)
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(ggeffects) # Create Tidy Data Frames of Marginal Effects for 'ggplot' from Model Outputs
library(gridExtra) # Miscellaneous Functions for "Grid" Graphics
library(DT) # A Wrapper of the JavaScript Library 'DataTables'
library(boot) # Diagnostics plots
```

## Área fixa em 10

### Análise exploratória

```{r fig.align = 'center', fig.width=8, fig.height=8}
AED(sim_Afix10, binw = 3)
```

### Seleção de modelos

<details>
  <summary>Modelos com área fixa em 10</summary>
```{r message=FALSE, warning=FALSE}
# 1. GLMM Cheio: efeito aleatório das cachoeiras sobre o intercepto + efeito fixo com tripla interação 

glmm10.1 = glmer(ttot~tamapad*freqpad*footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 2. GLMM sem tripla
glmm10.2 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+tamapad:footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 3. GLMM sem 1 dupla: freqpad:footpad
glmm10.3 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+tamapad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 4. GLMM sem 1 dupla: tamapad:footpad
glmm10.4 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 5. GLMM sem 1 dupla: tamapad:freqpad
glmm10.5 = glmer(ttot~tamapad+freqpad+footpad+tamapad:footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 6. GLMM sem 2 duplas: freqpad:footpad e tamapad:footpad
glmm10.6 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 7. GLMM sem 2 duplas: tamapad:footpad e tamapad:freqpad
glmm10.7 = glmer(ttot~tamapad+freqpad+footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 8. GLMM sem 2 duplas: freqpad:footpad e tamapad:freqpad
glmm10.8 = glmer(ttot~tamapad+freqpad+footpad+tamapad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 9. GLMM sem nenhuma dupla
glmm10.9 = glmer(ttot~tamapad+freqpad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 10. GLMM sem freqpad
glmm10.10 = glmer(ttot~tamapad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 11. GLMM sem footpad
glmm10.11 = glmer(ttot~tamapad+freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 12. GLMM sem tamapad
glmm10.12 = glmer(ttot~freqpad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 13. GLMM só com freqpad
glmm10.13 = glmer(ttot~freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 14. GLMM só com footpad
glmm10.14 = glmer(ttot~footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)

# 15. GLMM só com tamapad
glmm10.15 = glmer(ttot~tamapad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix10)
```
</details>

\

```{r}
# Seleção de Modelos
models10 = c(glmm10.1, glmm10.2, glmm10.3, glmm10.4, glmm10.5, glmm10.6, glmm10.7, glmm10.8, glmm10.9, glmm10.10, glmm10.11, glmm10.12, glmm10.13, glmm10.14, glmm10.15)
model.names10 = c("glmm10.1", "glmm10.2", "glmm10.3", "glmm10.4", "glmm10.5", "glmm10.6", "glmm10.7", "glmm10.8", "glmm10.9", "glmm10.10", "glmm10.11", "glmm10.12", "glmm10.13", "glmm10.14", "glmm10.15")
aictab(cand.set=models10, modnames=model.names10, refit=FALSE)
```

### Modelos plausíveis
Neste cenário, os modelos 1, 2 e 4 são igualmente plausíveis, uma vez que $\Delta AIC < 2$. Estes modelos tem em comum todas as três variáveis sem interação, e variam nas interações duplas e tripla que não possuem. A seguir, mostramos o sumário de todos esses modelos. Dentre todos os modelos, o tem menor valor de AIC e por esse motivo, concentraremos a análise neste. 
\

<details>
<summary>Sumário dos modelos plausíveis</summary>
```{r}
# Sumário do melhor modelo
summary(glmm10.1)
summary(glmm10.2)
summary(glmm10.4)
```
</details>

```{r}
# Plota 95% CI de um dos melhores modelos
plotConf(glmm10.4)
```

```{r fig.align= 'center', fig.width=8, fig.height=8}
# Plota linhas de tendência de um dos melhores modelos
plot_tendencia(dados = sim_Afix10, modelo = glmm10.4)
```

### Diagnósticos do modelo

```{r}
plot(glmm10.4)
```


## Área fixa em 50

### Análise exploratória

```{r fig.align= 'center', fig.width=8, fig.height=8}
AED(sim_Afix50, binw = 70)
```

### Seleção de modelos

<details>

  <summary>Modelos com área fixa em 50</summary>

```{r message=FALSE, warning=FALSE}
# 1. GLMM Cheio: efeito aleatório das cachoeiras sobre o intercepto + efeito fixo com tripla interação 
glmm50.1 = glmer(ttot~tamapad*freqpad*footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 2. GLMM sem tripla
glmm50.2 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+tamapad:footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 3. GLMM sem 1 dupla: freqpad:footpad
glmm50.3 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+tamapad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 4. GLMM sem 1 dupla: tamapad:footpad
glmm50.4 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 5. GLMM sem 1 dupla: tamapad:freqpad
glmm50.5 = glmer(ttot~tamapad+freqpad+footpad+tamapad:footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 6. GLMM sem 2 duplas: freqpad:footpad e tamapad:footpad
glmm50.6 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 7. GLMM sem 2 duplas: tamapad:footpad e tamapad:freqpad
glmm50.7 = glmer(ttot~tamapad+freqpad+footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 8. GLMM sem 2 duplas: freqpad:footpad e tamapad:freqpad
glmm50.8 = glmer(ttot~tamapad+freqpad+footpad+tamapad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 9. GLMM sem nenhuma dupla
glmm50.9 = glmer(ttot~tamapad+freqpad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 10. GLMM sem freqpad
glmm50.10 = glmer(ttot~tamapad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 11. GLMM sem footpad
glmm50.11 = glmer(ttot~tamapad+freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 12. GLMM sem tamapad
glmm50.12 = glmer(ttot~freqpad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 13. GLMM só com freqpad
glmm50.13 = glmer(ttot~freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 14. GLMM só com footpad
glmm50.14 = glmer(ttot~footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)

# 15. GLMM só com tamapad
glmm50.15 = glmer(ttot~tamapad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix50)
```
</details>

```{r}
# Seleção de modelo
models50 = c(glmm50.1, glmm50.2, glmm50.3, glmm50.4, glmm50.5, glmm50.6, glmm50.7, glmm50.8, glmm50.9, glmm50.10, glmm50.11, glmm50.12, glmm50.13, glmm50.14, glmm50.15)
model.names50 = gsub("10", "50", model.names10)
aictab(cand.set=models50, modnames=model.names50)
```

### Modelo mínimo adequado

<details>
<summary>Sumário do modelo mínimo adequado</summary>
```{r}
# Sumário do melhor modelo
summary(glmm50.1)
```
</details>

```{r}
# Plot 95% CI
plotConf(glmm50.1)
```

```{r fig.align= 'center', fig.width=8, fig.height=8}
# Plot da curva de tendência
plot_tendencia(dados = sim_Afix50, modelo = glmm50.1)
```

### Diagnósticos do modelo

```{r}
plot(glmm50.1)

```

## Área fixa em 100

### Análise exploratória

```{r fig.align= 'center', fig.width=8, fig.height=8}
AED(sim_Afix100, binw = 200)
```

### Seleção de modelos

<details>

  <summary>Modelos com área fixa em 100</summary>

```{r message=FALSE, warning=FALSE}
# 1. GLMM Cheio: efeito aleatório das cachoeiras sobre o intercepto + efeito fixo com tripla interação 
glmm100.1 = glmer(ttot~tamapad*freqpad*footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 2. GLMM sem tripla
glmm100.2 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+tamapad:footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 3. GLMM sem 1 dupla: freqpad:footpad
glmm100.3 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+tamapad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 4. GLMM sem 1 dupla: tamapad:footpad
glmm100.4 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 5. GLMM sem 1 dupla: tamapad:freqpad
glmm100.5 = glmer(ttot~tamapad+freqpad+footpad+tamapad:footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 6. GLMM sem 2 duplas: freqpad:footpad e tamapad:footpad
glmm100.6 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 7. GLMM sem 2 duplas: tamapad:footpad e tamapad:freqpad
glmm100.7 = glmer(ttot~tamapad+freqpad+footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 8. GLMM sem 2 duplas: freqpad:footpad e tamapad:freqpad
glmm100.8 = glmer(ttot~tamapad+freqpad+footpad+tamapad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 9. GLMM sem nenhuma dupla
glmm100.9 = glmer(ttot~tamapad+freqpad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 10. GLMM sem freqpad
glmm100.10 = glmer(ttot~tamapad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 11. GLMM sem footpad
glmm100.11 = glmer(ttot~tamapad+freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 12. GLMM sem tamapad
glmm100.12 = glmer(ttot~freqpad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 13. GLMM só com freqpad
glmm100.13 = glmer(ttot~freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 14. GLMM só com footpad
glmm100.14 = glmer(ttot~footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)

# 15. GLMM só com tamapad
glmm100.15 = glmer(ttot~tamapad + (1|nsim), family=Gamma(link = "log"), data=sim_Afix100)
```
</details>

```{r}
# Seleção de modelo
models100 = c(glmm100.1, glmm100.2, glmm100.3, glmm100.4, glmm100.5, glmm100.6, glmm100.7, glmm100.8, glmm100.9, glmm100.10, glmm100.11, glmm100.12, glmm100.13, glmm100.14, glmm100.15)
model.names100 = gsub("10", "100", model.names10)
aictab(cand.set=models100, modnames=model.names100)
```

### Modelos plausíveis

Os modelos 1 e 2 são igualmente plausíveis pois $\Delta AIC < 2$. O modelo 1 inclui todas as preditoras <code>tamapad</code>, <code>footpad</code>, <code>freqpad</code> e suas interações duplas e tripla. O modelo 2, por sua vez, não possui a interação tripla. Por ter menor AIC, apresentamos o modelo 2 em detalhes:

<details>
<summary>Sumário dos modelos plausíveis</summary>
```{r}
# Sumário do melhor modelo
summary(glmm100.1)
summary(glmm100.2)
```
</details>

```{r}
# Plot 95% CI de um dos modelos selecionados
plotConf(glmm100.2)
```

```{r fig.align= 'center', fig.width=8, fig.height=8}
# Plot da curva de tendência de um dos modelos selecionados
plot_tendencia(dados = sim_Afix100, modelo = glmm100.2)
```

### Diagnósticos do modelo

```{r}
plot(glmm100.2)
```

## Simulação com área variável

### Análise exploratória
```{r fig.align= 'center', fig.width=8, fig.height=8}
# Padroniza área
sim_Avar$areapad = padroniza(sim_Avar$area)

# AED
AED(sim_Avar, binw = 200)
```

### Seleção de modelos

Nos modelos com área variável, seria possível incluir a area também como variável preditora. Optamos por não fazer isso por dois motivos: (1) O efeito da variação da área de certa forma já está incluído na variável aleatória <code>nsim</code>. (2) O modelo mais complexo com as 4 preditoras e suas interações não converge.

```{r eval = FALSE}
sim_Avar$areapad = padroniza(sim_Avar$area)
glmmvar.full = glmer(ttot~tamapad*freqpad*footpad*areapad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# Warning message:
# In checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,  :
#   Model failed to converge with max|grad| = 0.165652 (tol = 0.002, component 1)
```

<details>

  <summary>Modelos com área variável</summary>
```{r message=FALSE, warning=FALSE}

# 1. GLMM Cheio: efeito aleatório das cachoeiras sobre o intercepto + efeito fixo com tripla interação 
glmmvar.1 = glmer(ttot~tamapad*freqpad*footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 2. GLMM sem tripla
glmmvar.2 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+tamapad:footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 3. GLMM sem 1 dupla: freqpad:footpad
glmmvar.3 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+tamapad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 4. GLMM sem 1 dupla: tamapad:footpad
glmmvar.4 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 5. GLMM sem 1 dupla: tamapad:freqpad
glmmvar.5 = glmer(ttot~tamapad+freqpad+footpad+tamapad:footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 6. GLMM sem 2 duplas: freqpad:footpad e tamapad:footpad
glmmvar.6 = glmer(ttot~tamapad+freqpad+footpad+tamapad:freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 7. GLMM sem 2 duplas: tamapad:footpad e tamapad:freqpad
glmmvar.7 = glmer(ttot~tamapad+freqpad+footpad+freqpad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 8. GLMM sem 2 duplas: freqpad:footpad e tamapad:freqpad
glmmvar.8 = glmer(ttot~tamapad+freqpad+footpad+tamapad:footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 9. GLMM sem nenhuma dupla
glmmvar.9 = glmer(ttot~tamapad+freqpad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 10. GLMM sem freqpad
glmmvar.10 = glmer(ttot~tamapad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 11. GLMM sem footpad
glmmvar.11 = glmer(ttot~tamapad+freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 12. GLMM sem tamapad
glmmvar.12 = glmer(ttot~freqpad+footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 13. GLMM só com freqpad
glmmvar.13 = glmer(ttot~freqpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 14. GLMM só com footpad
glmmvar.14 = glmer(ttot~footpad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)

# 15. GLMM só com tamapad
glmmvar.15 = glmer(ttot~tamapad + (1|nsim), family=Gamma(link = "log"), data=sim_Avar)
```
</details>

```{r}
# Seleção de modelo
modelsvar = c(glmmvar.1, glmmvar.2, glmmvar.3, glmmvar.4, glmmvar.5, glmmvar.6, glmmvar.7, glmmvar.8, glmmvar.9, glmmvar.10, glmmvar.11, glmmvar.12, glmmvar.13, glmmvar.14, glmmvar.15)
model.namesvar = gsub("10", "var", model.names10)
aictab(cand.set=modelsvar, modnames=model.namesvar)
```

### Modelos plausíveis

Os modelos 1 e 2 são igualmente plausíveis pois $\Delta AIC < 2$. O modelo 1 inclui todas as preditoras <code>tamapad</code>, <code>footpad</code>, <code>freqpad</code> e suas interações duplas e tripla. O modelo 2, por sua vez, não possui a interação tripla. Por ter menor AIC, apresentamos o modelo 2 em detalhes:

<details>
<summary>Sumário dos modelos plausíveis</summary>
```{r}
# Sumário dos modelos selecionados
summary(glmmvar.1)
summary(glmmvar.2)
```
</details>

```{r}
# Plot 95% CI de um dos modelos selecionados
plotConf(glmmvar.2)
```

```{r fig.align= 'center', fig.width=8, fig.height=8}
# Plot de curva de tendência de um dos modelos selecionados
plot_tendencia(dados = sim_Avar, modelo = glmmvar.2)
```

### Diagnósticos do modelo

```{r}
plot(glmmvar.2)
```

# Discussão

Neste estudo, exploramos como sinais multi-modais influenciam o tempo até o início do amplexo na rã-de-corredeira. Três variáveis preditoras foram consideradas na composição do sinal multi-modal: frequência dominante (DF), tamanho corporal e taxa de *foot-flagging*. Esperávamos uma relação positiva entre tempo até o amplexo e frequência dominante, porém uma relação negativa entre tempo até o amplexo e tamanho corporal e taxa de *foot-flagging*. Após criarmos sistemas que simulam riachos de diferentes tamanhos com a probabilidade de fêmeas escolhererem machos associada a estes sinais multi-modais, utilizamos GLMMs com distribuição Gama para testar se esses modelos convergem bem aos parâmetros utilizados durante a simulação. Abaixo, discutimos a interpretação biológica dos resultados, o efeito do tamanho das cachoeiras de área fixa (10, 50 e 100) e variável, se os coeficientes verdadeiros (utilizados na simulação) convergem com aqueles estimados pelos GLMMs e quais as limitações do nosso estudo. 

## O efeito dos sinais multi-modais sobre o tempo

Para todas as áreas (fixa em 10, 50 e 100, e variável), nossos resultados indicam que modelos com dupla e/ou tripla interação entre os sinais acústico, visual e morfológico são sempre selecionados. Embora a interação entre os coeficientes não tenha sido explicitamente considerada na simulação da seleção de machos pelas fêmeas, estas interações emergem nos GLMMs utilizando a distribuição Gama.

Biologicamente, a interação estatística entre nossas variáveis aleatórias pode ser interpretada como um sinal multi-modal, ou seja, a informação sobre a qualidade do macho é composta por diferentes sub-conjuntos de sinais que interagem entre si para influenciar o tempo até o amplexo. Especificamente, três sinais podem fazer parte do sinal multi-modal em nosso sistema: acústico, visual e morfológico. A frequência dominante é o sinal acústico que atrai as fêmeas que estão longe, sendo que uma grande quantidade de energia dos machos é gasta diariamente para bombear o ar durante o canto (Wells 2007). Contudo, conforme elas se aproximam dos rios, outros sinais possivelmente são importantes para informar a qualidade do macho: o tamanho corporal (morfologia) e o *foot-flagging* (sinais visuais).

## Comparação de coeficientes

Seguimos o critério de que um modelo é definitivamente mais plausível se tem $\Delta AIC$ < 2. Em caso de empate, consideramos que os modelos selecionados cuja diferença de AIC é menor do que 2 são igualmente plausíveis. Com exceção da área fixa de 50, nota-se que mais de um modelo foi escolhido por área.
Para comparar os modelos plausíveis com as simulações, apresentamos na tabela abaixo os coeficientes colocados nas simulações e os encontrados pelos modelos selecionados pelo critério de $AIC$. Em cinza escuro estão as linhas de input da simulação e abaixo delas nos modelos plausíveis para cada variação na área. Os modelos plausíveis são apresentados em ordem de $\Delta AIC$ crescente.
\
\
<center>Tabela 1 - Coeficientes utilizados em cada simulação (cinza escuro) e obtidos pelos modelos ajustados (branco)</center>
```{r echo=FALSE}
#extrai coeficientes dos modelos plausiveis de cada area
sim10 = c(cfsim_Afix10, rep(NA, times = 4))
cfglmm10.4 = c(summary(glmm10.4)$coefficients[,1], NA, NA)
cfglmm10.2 = c(summary(glmm10.2)$coefficients[,1], NA)
cfglmm10.1 = summary(glmm10.1)$coefficients[,1]

sim50 = c(cfsim_Afix50, rep(NA, times = 4))
cfglmm50.1 = summary(glmm50.1)$coefficients[,1]

sim100 = c(cfsim_Afix100, rep(NA, times = 4))
cfglmm100.2 = c(summary(glmm100.2)$coefficients[,1], NA)
cfglmm100.1 = summary(glmm100.1)$coefficients[,1]

simvar = c(cfsim_Avar, rep(NA, times = 4))
cfglmmvar.2 = c(summary(glmmvar.2)$coefficients[,1], NA)
cfglmmvar.1 = summary(glmmvar.1)$coefficients[,1]

#como ha modelos sem alguns coeficientes, preciso adicionar eles como NA no vetor para fazer uma tabela
colnames = attributes(summary(glmm10.1)$coefficients)$dimnames[[1]]
names(cfglmm10.4)[c(7,8)] = c(colnames[!colnames %in% names(cfglmm10.4)])
names(cfglmm10.2)[8] = "tamapad:freqpad:footpad"
names(cfglmm100.2)[8] = "tamapad:freqpad:footpad"
names(cfglmmvar.2)[8] = "tamapad:freqpad:footpad"

#e ordenar para ficar igual aos outros
cfglmm10.4 = cfglmm10.4[colnames]

#fazer tabela e mudar nomes
cftab = data.frame(sim10, cfglmm10.4, cfglmm10.2, cfglmm10.1, sim50, cfglmm50.1, sim100, cfglmm100.2, cfglmm100.1, simvar, cfglmmvar.2, cfglmmvar.1)
names(cftab) = gsub(pattern = "cf", replacement = "", x = names(cftab))
names(cftab) = gsub(pattern = "sim", replacement = "sim_Afix", x = names(cftab))
names(cftab)[10] = "sim_Avar"
rownames(cftab) = gsub(pattern = "pad", replacement = "", x = rownames(cftab))

cftab = t(cftab)
cftab = round(cftab, 2)

# tabela com formatacao bonita
datatable(cftab, options = list(paging = FALSE)) %>%
formatStyle("(Intercept)",
  target = 'row',
  fontWeight = styleEqual(c(0, 1), c('bold', '')),
  backgroundColor = styleEqual(c(0, 1), c(rgb(0.8, 0.8, 0.8, 0.5), 'white')))
```

Apesar de o intercepto de todos as simulações ser $0$, observamos que todos os modelos ajustados possuem valores de intercepto positivos, e que este valor aumenta conforme o aumento da área. Quanto aos coeficientes de tamanho, e de frequência, os coeficientes ajustados possuem mesmo sinal (negativo e positivo, respectivamente) que os simulados, porém com magnitude menor do que a esperada. O coeficiente da taxa de *foot-flagging*, por sua vez, tem magnitude menor do que a esperada e sinal contrário ao simulado. Interessantemente, a taxa de *foot-flagging* foi o único parâmetro simulado a partir de uma distribuição Poisson, ao passo que a frequência dominante e tamanho corporal foram simuladas com uma distribuição Gaussiana. 

É possível notar também que, apesar da variação em área, o valor dos coeficientes entre simulações é bastante parecido, o que é compatível com o simulado. Sob uma abordagem frequentista, observa-se que os valores de p da maioria dos coeficientes dos modelos selecionados são menores do que 0.05 e portanto podem ser interpretados como *significativos*. Sob uma abordagem de modelos, esses coeficientes apresentam intervalos de confiança que não se sobrepõem com zero.

Quanto aos coeficientes de interação, todos tem magnitude de efeito pequena, o que é condizente com a simulação pois estes efeitos não foram incluídos. Mesmo assim, o ajuste de modelos demonstra que as interações duplas são essenciais para entender os modelos, e as interações triplas podem ou não melhorar o ajuste do modelo. Este fato pode ser explicado pois todas as características são correlacionadas com a distância do macho até a cachoeira, e portanto as características podem ser correlacionadas entre si. 

## Limitações dos modelos

Como já dito, o ajuste dos modelos com a função de ligação canônica não foi possível, uma vez que nos modelos mais complexos resultava em erro. Por isso, optamos pela função de ligação log. Essa opção pode ter gerado algumas das diferenças observadas entre a simulação e os previstos pelo modelo. Como exemplo desta diferença, mostramos novamente as curvas previstas para o modelo de área 100. A função de ligação log permite o formato da curva apenas crescente ou decrescente, no entanto a função de ligação logística permitiria o formato de "S" mais adequado aos dados.

```{r fig.align= 'center', fig.width=8, fig.height=8}
plot_tendencia(dados = sim_Afix100, modelo = glmm100.1)
```


# Referências

Bolker at al 2022. GLMM FAQ <https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#reml-for-glmms>.

Duellman, W. E., & Trueb, L. (1986). Biology of Amphibians McGraw-Hill Inc. Nueva York, EUA.

Gingras, B., Mohandesan, E., Boko, D., & Fitch, W. (2013). Phylogenetic signal in the acoustic parameters of the advertisement calls of four clades of anurans. BMC Evolutionary Biology, 13(1), 1-12.

Goutte, S., Dubois, A., & Legendre, F. (2013). The importance of ambient sound level to characterise anuran habitat. Plos One, 8(10), e78020.

Haddad, C. F., & Giaretta, A. A. (1999). Visual and acoustic communication in the Brazilian torrent frog, *Hylodes asper* (Anura: Leptodactylidae). Herpetologica, 324-333.

Heyer, W. R., Rand, A. S., da Cruz, C. A. G., Peixoto, O. L., & Nelson, C. E. (1990). Frogs of Boracéia. Arquivos de Zoologia, 31(4), 231-410.

Hödl, W., Rodrigues, M. T., Accacio, G. M., Lara, P. H., Pavan, D., Schiesari, L., & Skuk, G. (1997). Foot-flagging display in the Brazilian stream-breeding frog *Hylodes asper* (Leptodactylidae). Scientific film, Ctf, 2703.

Köhler, J., Jansen, M., Rodríguez, A., Kok, P. J. R., Toledo, L. F., Emmrich, M., Glaw F., Haddad, C. F. B., Rodel, M., Vences, M. (2017). The use of bioacoustics in anuran taxonomy: Theory, terminology, methods and recommendations for best practice. Zootaxa, 4251, 1–124.

Lo, Steson, and Sally Andrews. 2015. “To Transform or Not to Transform: Using Generalized Linear Mixed Models to Analyse Reaction Time Data.” Frontiers in Psychology 6. https://doi.org/10.3389/fpsyg.2015.01171.

Martin, W. F. (1971). Mechanics of sound production in toads of the genus Bufo: passive elements. Journal of Experimental Zoology, 176(3), 273-293.

McClelland, B. E., Wilczynski, W. A. L. T. E. R., & Ryan, M. J. (1996). Correlations between call characteristics and morphology in male cricket frogs (Acris crepitans). The Journal of Experimental Biology, 199(9), 1907-1919.

Ryan, M. J. (1988). Constraints and patterns in the evolution of anuran acoustic communication. The evolution of the amphibian auditory system, 637-677.

Schmid, E. (1978). Contribution to the morphology and histology of the vocal cords of Central European anurans (Amphibia). Zoologische Jahrbucher Anatomie, 5, 133-150.

Wells, K. D. (1977). The social behaviour of anuran amphibians. Animal Behaviour, 25, 666-693.



